---







import FeatureDashboard from './feature-list/FeatureDashboard.astro'

interface Props {
  features: string[]
}

const { features } = Astro.props

interface FeatureData {
  id: string
  name: string
  description: string
  category: 'HTML' | 'CSS' | 'JavaScript' | 'Web Platform'
  status: 'limited' | 'newly' | 'widely' | 'unknown'
  date: string
}

const getCategory = (links: { link: string }[]) => {
  if (!links || links.length === 0) return 'Web Platform'
  for (const l of links) {
    if (l.link.includes('csswg') || l.link.includes('css')) return 'CSS'
    if (l.link.includes('tc39') || l.link.includes('ecma')) return 'JavaScript'
    if (l.link.includes('html') || l.link.includes('whatwg')) return 'HTML'
  }
  return 'Web Platform'
}

const featureData: FeatureData[] = await Promise.all(
  [...new Set(features)].map(async id => {
    try {
      const [featureRes, metadataRes] = await Promise.all([
        fetch(`https://api.webstatus.dev/v1/features/${id}`),
        fetch(`https://api.webstatus.dev/v1/features/${id}/feature-metadata`),
      ])

      if (!featureRes.ok) {
        console.error(`Failed to fetch feature ${id}: ${featureRes.statusText}`)
        return {
          id,
          name: id,
          description: 'Failed to load feature data.',
          category: 'Web Platform',
          status: 'unknown',
          date: '1970-01-01',
        }
      }

      const featureFn = await featureRes.json()
      const name = featureFn.name || id
      const status = featureFn.baseline?.status || 'unknown'
      // Use low_date for availability, fall back to "future" (9999) for limited features to sort them as "newest"
      const date =
        featureFn.baseline?.low_date ||
        (status === 'limited' ? '9999-12-31' : '1970-01-01')
      const category = getCategory(featureFn.spec?.links || [])

      let description = ''
      if (metadataRes.ok) {
        const metadata = await metadataRes.json()
        description = metadata.description || ''
      }

      return {
        id,
        name,
        description,
        category,
        status,
        date,
      }
    } catch (e) {
      console.error(`Error fetching ${id}`, e)
      return {
        id,
        name: id,
        description: 'Error loading data.',
        category: 'Web Platform',
        status: 'unknown',
        date: '1970-01-01',
      }
    }
  }),
)

// Get unique categories for the filter
const categories = Array.from(new Set(featureData.map(f => f.category))).sort()
const statuses = Array.from(new Set(featureData.map(f => f.status))).sort()

// Default sort (Newest/Future first)
const sortedFeatureData = featureData.sort((a, b) =>
  b.date.localeCompare(a.date),
)
---

<FeatureDashboard features={sortedFeatureData} />
