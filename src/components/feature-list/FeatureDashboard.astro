---
import FeatureCard from "./FeatureCard.astro";
import FeatureControls from "./FeatureControls.astro";
import styles from "./FeatureDashboard.module.css";
import type { FeatureData } from "./types";

interface Props {
  features: FeatureData[];
}

const { features } = Astro.props;

// Category colors mapping
const CATEGORY_COLORS: Record<string, string> = {
  HTML: "var(--html-color)",
  CSS: "var(--css-color)",
  JavaScript: "var(--js-color)",
  "Web Platform": "var(--web-platform-color)",
};

const getCategoryColor = (category: string) =>
  CATEGORY_COLORS[category] || "var(--sl-color-text-accent)";

const slugify = (text: string) =>
  text
    .toString()
    .toLowerCase()
    .trim()
    .replace(/\s+/g, "-")
    .replace(/[^\w-]+/g, "")
    .replace(/--+/g, "-");

// Group features by category
const groupedFeatures = features.reduce(
  (acc, feature) => {
    if (!acc[feature.category]) {
      acc[feature.category] = [];
    }
    acc[feature.category].push(feature);
    return acc;
  },
  {} as Record<string, FeatureData[]>
);

const categories = Object.keys(groupedFeatures).sort();
---

<feature-dashboard class={styles["feature-dashboard"]}>
  <FeatureControls features={features} />

  <div class={styles["features-container"]} data-root>
    {
      categories.map((category) => {
        const slug = slugify(category);
        const color = getCategoryColor(category);
        return (
          <details
            class={styles["category-group"]}
            data-category-group={category}
            open
          >
            <summary
              class={styles["category-header"]}
              style={`--category-color: ${color}`}
            >
              <h2 id={slug} class={styles["category-title"]}>
                {category}
              </h2>
              <a
                class={styles["anchor-link"]}
                href={`#${slug}`}
                aria-labelledby={slug}
              >
                <span aria-hidden="true" class="sl-anchor-icon">
                  <svg width="16" height="16" viewBox="0 0 24 24">
                    <path
                      fill="currentcolor"
                      d="m12.11 15.39-3.88 3.88a2.52 2.52 0 0 1-3.5 0 2.47 2.47 0 0 1 0-3.5l3.88-3.88a1 1 0 0 0-1.42-1.42l-3.88 3.89a4.48 4.48 0 0 0 6.33 6.33l3.89-3.88a1 1 0 1 0-1.42-1.42Zm8.58-12.08a4.49 4.49 0 0 0-6.33 0l-3.89 3.88a1 1 0 0 0 1.42 1.42l3.88-3.88a2.52 2.52 0 0 1 3.5 0 2.47 2.47 0 0 1 0 3.5l-3.88 3.88a1 1 0 1 0 1.42 1.42l3.88-3.89a4.49 4.49 0 0 0 0-6.33ZM8.83 15.17a1 1 0 0 0 1.1.22 1 1 0 0 0 .32-.22l4.92-4.92a1 1 0 0 0-1.42-1.42l-4.92 4.92a1 1 0 0 0 0 1.42Z"
                    />
                  </svg>
                </span>
                <span class="sr-only">Section titled “{category}”</span>
              </a>
            </summary>
            <div class={styles["features-grid"]} data-grid>
              {groupedFeatures[category].map((feature) => (
                <FeatureCard feature={feature} />
              ))}
            </div>
          </details>
        );
      })
    }
  </div>

  <div data-no-results class={`${styles["no-results"]} hidden`}>
    No features match the current filters.
  </div>
</feature-dashboard>

<script>
  import { FeatureDashboardLogic } from "./dashboard-logic";

  class FeatureDashboard extends HTMLElement {
    constructor() {
      super();
      new FeatureDashboardLogic(this);
    }
  }

  customElements.define("feature-dashboard", FeatureDashboard);
</script>

<style>
  /* Global utility class for hidden state handled by script */
  :global(.hidden) {
    display: none !important;
  }
</style>
